<div class="tab-pane" id="applications" role="tabpanel" aria-labelledby="applications-tab" style="min-height: 500px;">

    <table width=100% style=" border-spacing: 10px;   border-collapse: separate;">

        <tr id="addApplicationTR">
            <td align="right">
                <select class="form-select" aria-label="Default select example" id="applicationsLeft"
                    style="min-width: 300px;">
                </select><br>
                <button type="button" class="btn btn-sm btn-success" onclick="javascript:addAccountToApplication()">Add
                    Application</button>
            </td>
        </tr>

        <tr>
            <td align="center">
                <h5 style="text-align: left;">User Applications:</h5>
                <hr>
            </td>
        </tr>

        <tr>
            <td align="center" id="accountScopesTD">
            </td>
        </tr>

    </table>
</div>

<script>

    function populateAccountApplications() {
        document.getElementById('accountScopesTD').innerHTML = "";
        document.getElementById('applicationsLeft').innerHTML = "";

        $.ajax({
            url: '/api/v1/getAccountApplications',
            type: 'GET',
            contentType: 'application/json',
            data: JSON.stringify({
                accountName: currentAccount
            }),
            success: function (response, textStatus, xhr) {
                if (response["applicationsLeft"] != null) {
                    for (let applicationLeft of response["applicationsLeft"]) {

                        var sel = document.getElementById('applicationsLeft');
                        var opt = document.createElement('option');
                        opt.appendChild(document.createTextNode(applicationLeft["name"] + ': ' + applicationLeft["description"]));
                        opt.value = applicationLeft["name"];
                        sel.appendChild(opt);
                    }
                }

                if (response["applications"] != null) {
                    let appId = 0;
                    for (let application of response["applications"]) {

                        $("#accountScopesTD").append(`
                                    <input type=hidden id="userapp-key-${appId}">
                                    <div class="card" style="max-width: 80%; text-align: left;">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0" id="userapp-title-${appId}">Text Left</h5>
                                            <button type="button" class="btn btn-sm btn-secondary"
                                                onclick="javascript:removeAccountFromApplication('${appId}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </button>
                                        </div>

                                        <div class="card-body">
                                            <div class="text-end">
                                                <select class="form-select" aria-label="Default select example" id="applicationsScopesLeft-${appId}"
                                                    style="min-width: 300px;">
                                                </select><br>
                                                <button type="button" class="btn btn-sm btn-success"
                                                    onclick="javascript:addApplicationScopeToAccount('${appId}')">Add Scope</button>
                                            </div>
                                            <br>
                                            <p class="card-text">
                                            <table class="table table-hover">
                                                <thead class="thead-light">
                                                    <tr bgcolor=grey>
                                                        <th scope="col">Scope Name</th>
                                                        <th scope="col">Description</th>
                                                        <th scope="col" style="text-align: right;">Controls</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="applicationsDirectScopes-${appId}">
                                                </tbody>
                                            </table>
                                            </p>

                                        </div>
                                    </div>
                                    <br>
                                `
                        );
                        $(`#userapp-title-${appId}`).text(application["name"] + ': ' + application["description"]);
                        $(`#userapp-key-${appId}`).val(application["name"]);

                        if (application["directScopesLeft"] != null) {
                            for (let scopeLeft of application["directScopesLeft"]) {
                                var sel = document.getElementById(`applicationsScopesLeft-${appId}`);
                                var opt = document.createElement('option');
                                opt.appendChild(document.createTextNode('[' + scopeLeft["id"] + '] ' + scopeLeft["description"]));
                                opt.value = scopeLeft["id"];
                                sel.appendChild(opt);
                            }
                        }

                        if (application["directScopes"] != null) {
                            let scopeInternalId = 0;

                            for (let directScope of application["directScopes"]) {

                                document.getElementById(`applicationsDirectScopes-${appId}`).innerHTML += `
                                    <tr> 
                                    <th scope="row" id=ulist-scopeId-${appId}-${scopeInternalId} width=20%></th>
                                    <td id=ulist-scopeDescription-${appId}-${scopeInternalId}></td>
                                    <td style="text-align: right;">
                                        <input type=hidden id="ulist-scopeIdByInternalId-${appId}-${scopeInternalId}">
                                        <button type="button" class="btn btn-light btn-sm" onclick="javascript:removeApplicationScopeFromAccount(${appId},${scopeInternalId});">&#10006;</button>
                                    </td>
                                    </tr>`;

                                document.getElementById(`ulist-scopeIdByInternalId-${appId}-${scopeInternalId}`).value = directScope["id"];
                                $(`#ulist-scopeId-${appId}-${scopeInternalId}`).text(directScope["id"]);
                                $(`#ulist-scopeDescription-${appId}-${scopeInternalId}`).text(directScope["description"]);
                                scopeInternalId++;
                            }
                        }
                        appId++;
                    }
                }

            },
            error: commonFunctionError
        });
    }

    function removeApplicationScopeFromAccount(appId, scopeId) {
        $.ajax({
            url: '/api/v1/removeApplicationScopeFromAccount',
            type: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({
                appName: document.getElementById(`userapp-key-${appId}`).value,
                scopeId: document.getElementById(`ulist-scopeIdByInternalId-${appId}-${scopeId}`).value,
                accountName: currentAccount
            }),
            success: function (response) {
                populateAccountApplications();
            },
            error: commonFunctionError
        });

    }

    function addApplicationScopeToAccount(appId) {
        var appItems = document.getElementById(`applicationsScopesLeft-${appId}`);
        var selItem = appItems.selectedIndex;
        if (selItem == -1) {
            showToastError('Please select an scope');
            document.getElementById(`applicationsScopesLeft-${appId}`).focus();
            return;
        }

        $.ajax({
            url: '/api/v1/addApplicationScopeToAccount',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                appName: $(`#userapp-key-${appId}`).val(),
                scopeId: appItems.value,
                accountName: currentAccount
            }),
            success: function (response) {
                populateAccountApplications();
            },
            error: commonFunctionError
        });
    }

    function removeAccountFromApplication(appId) {
        var appName = document.getElementById(`userapp-key-${appId}`).value;
        showYesNoDialog("Do you really want to remove this application from the account?", function (result) {
            if (result) {
                $.ajax({
                    url: '/api/v1/removeAccountFromApplication',
                    type: 'DELETE',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        accountName: currentAccount,
                        appName: appName
                    }),
                    success: function (response) {
                        populateAccountApplications();
                    },
                    error: commonFunctionError
                });
            }
        });
    }

    function addAccountToApplication() {
        var appItems = document.getElementById("applicationsLeft");
        var selItem = appItems.selectedIndex;
        if (selItem == -1) {
            showToastError('Please select an application');
            document.getElementById("applicationsLeft").focus();
            return;
        }

        $.ajax({
            url: '/api/v1/addAccountToApplication',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                accountName: currentAccount,
                appName: appItems.value
            }),
            success: function (response) {
                populateAccountApplications();
            },
            error: commonFunctionError
        });
    }
</script>
