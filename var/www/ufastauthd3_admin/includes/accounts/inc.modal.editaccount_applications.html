<div class="tab-pane fade" id="applications" role="tabpanel" aria-labelledby="applications-tab"
    style="min-height: 500px;">

    <table width=100% style=" border-spacing: 10px;   border-collapse: separate;">

        <tr id="addApplicationTR">
            <td align="right">
                <select class="form-select" aria-label="Default select example" id="applicationsLeft"
                    style="min-width: 300px;">
                </select><br>
                <button type="button" class="btn btn-sm btn-success" onclick="javascript:addApplication()">Add
                    Application</button>
            </td>
        </tr>

        <tr>
            <td align="center">
                <h5 style="text-align: left;">User Applications:</h5>
                <hr>
            </td>
        </tr>

        <tr>
            <td align="center" id="accountScopesTD">
            </td>
        </tr>

    </table>
</div>

<script>

    function populateAccountApplications(currentAccount) {
        document.getElementById('accountScopesTD').innerHTML = "";
        document.getElementById('applicationsLeft').innerHTML = "";

        $.ajax({
            url: '/api/v1/getAccountApplications',
            type: 'GET',
            contentType: 'application/json',
            data: JSON.stringify({
                accountName: currentAccount
            }),
            success: function (response, textStatus, xhr) {
                if (response["applicationsLeft"] != null) {
                    for (let applicationLeft of response["applicationsLeft"]) {

                        var sel = document.getElementById('applicationsLeft');
                        var opt = document.createElement('option');
                        opt.appendChild(document.createTextNode(applicationLeft["name"] + ': ' + applicationLeft["description"]));
                        opt.value = applicationLeft["name"];
                        sel.appendChild(opt);
                    }
                }

                if (response["applications"] != null) {
                    let appId = 0;
                    for (let application of response["applications"]) {

                        $("#accountScopesTD").append(
                            `
                                <input type=hidden id="userapp-key-${appId}">
                                <div class="card" style="max-width: 80%; text-align: left;">
                                <div class="card-header">
                                    <h5 style="float: left; width: 50%; text-align: left;" id="userapp-title-${appId}">Text Left</h2>
                                    <p style="float: left; width: 50%; text-align: right;">  <button type="button" class="btn btn-sm btn-light" onclick="javascript:removeApplication('${appId}')">	&#10006;</button> </p>
                                </div>

                                <div class="card-body">
                                    <table width=100% style=" border-spacing: 10px;   border-collapse: separate;"><tr><td align=right>
                                    <select class="form-select" aria-label="Default select example" id="applicationsScopesLeft-${appId}" style="min-width: 300px;">
                                    </select><br>
                                    <button type="button" class="btn btn-sm btn-success" onclick="javascript:addApplicationScope('${appId}')">Add Application Scope</button>
                                    </td></tr>
                                    </table>

                                <br>
                                <p class="card-text">
                                    <table class="table table-hover">
                                        <thead class="thead-light">
                                        <tr bgcolor=grey>
                                            <th scope="col">Scope Name</th>
                                            <th scope="col">Description</th>
                                            <th scope="col" style="text-align: right;">Controls</th>
                                        </tr>
                                        </thead>
                                        <tbody id="applicationsDirectScopes-${appId}">
                                        </tbody>
                                    </table>
                                </p>

                                </div>
                                </div>
                                <br>
                                `
                        );
                        $(`#userapp-title-${appId}`).text(application["name"] + ': ' + application["description"]);
                        $(`#userapp-key-${appId}`).val(application["name"]);

                        if (application["directScopesLeft"] != null) {
                            for (let permissionLeft of application["directScopesLeft"]) {
                                var sel = document.getElementById(`applicationsScopesLeft-${appId}`);
                                var opt = document.createElement('option');
                                opt.appendChild(document.createTextNode(permissionLeft["name"] + ': ' + permissionLeft["description"]));
                                opt.value = permissionLeft["name"];
                                sel.appendChild(opt);
                            }
                        }

                        if (application["directScopes"] != null) {
                            let permissionId = 0;

                            for (let directAttrib of application["directScopes"]) {

                                document.getElementById(`applicationsDirectScopes-${appId}`).innerHTML += `
                                    <tr> 
                                    <th scope="row" id=ulist-permissionName-${appId}-${permissionId} width=20%></th>
                                    <td id=ulist-permissionDescription-${appId}-${permissionId}></td>
                                    <td style="text-align: right;">
                                        <input type=hidden id="ulist-permissionNameById-${appId}-${permissionId}">
                                        <button type="button" class="btn btn-light btn-sm" onclick="javascript:permissionRemove(${appId},${permissionId});">&#10006;</button>
                                    </td>
                                    </tr>`;

                                document.getElementById(`ulist-permissionNameById-${appId}-${permissionId}`).value = directAttrib["name"];
                                $(`#ulist-permissionName-${appId}-${permissionId}`).text(directAttrib["name"]);
                                $(`#ulist-permissionDescription-${appId}-${permissionId}`).text(directAttrib["description"]);
                                permissionId++;
                            }
                        }
                        appId++;
                    }
                }

            },
            error: commonFunctionError
        });
    }

    function scopeRemove(appId, scopeId) {
        $.ajax({
            url: '/api/v1/scopeAccountRemove',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                appName: document.getElementById(`userapp-key-${appId}`).value,
                scopeName: document.getElementById(`ulist-scopeNameById-${appId}-${scopeId}`).value,
                accountName: $(`#accountName`).val()
            }),
            success: function (response) {
                populateAccount();
            },
            error: commonFunctionError
        });

    }

    function addApplicationScope(appId) {
        var appItems = document.getElementById(`applicationsScopesLeft-${appId}`);
        var selItem = appItems.selectedIndex;
        if (selItem == -1) {
            alert('Please select an scope');
            document.getElementById(`applicationsScopesLeft-${appId}`).focus();
            return;
        }

        $.ajax({
            url: '/api/v1/scopeAccountAdd',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                appName: $(`#userapp-key-${appId}`).val(),
                scopeName: appItems.value,
                accountName: $(`#accountName`).val()
            }),
            success: function (response) {
                populateAccount();
            },
            error: commonFunctionError
        });
    }

    function removeApplication(appId) {
        var appName = document.getElementById(`userapp-key-${appId}`).value;

        $.ajax({
            url: '/api/v1/applicationAccountRemove',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                accountName: $("#accountName").val(),
                appName: appName
            }),
            success: function (response) {
                populateAccount();
            },
            error: commonFunctionError
        });
    }

    function addApplication() {
        var appItems = document.getElementById("applicationsLeft");
        var selItem = appItems.selectedIndex;
        if (selItem == -1) {
            alert('Please select an application');
            document.getElementById("applicationsLeft").focus();
            return;
        }

        $.ajax({
            url: '/api/v1/applicationAccountAdd',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                accountName: $("#accountName").val(),
                appName: appItems.value
            }),
            success: function (response) {
                populateAccount();
            },
            error: commonFunctionError
        });
    }
</script>