<script>

    function createApplicationClearParameters() {
        generateRandomKey("appKeyCreate");
        $("#appNameCreate").val('');
        $("#appDescriptionCreate").val('');
        $("#scopesModifiableCreate").prop("checked", false);
        $("#initializeDefaultsCreate").prop("checked", true);
        // TODO:
        $('.nav-tabs a:first').tab('show')
    }


    function ajaxCreateApplication() {

        var appName = $("#appNameCreate").val().trim();
        var appDescription = $("#appDescriptionCreate").val().trim();

        if (appName === '') {
            $("#appNameCreate").focus();
            return false;
        }

        if (appDescription === '') {
            $("#appDescriptionCreate").focus();
            return false;
        }

        var appURL = $("#appURLCreate").val().trim();
        // Check if appURL is a valid URL and starts with https
        try {
            var urlObj = new URL(appURL);
            if (urlObj.protocol !== 'https:') {
                showToastError("URL must use HTTPS protocol");
                $("#appURLCreate").focus();
                return false;
            }
            // Check that the URL has no path
            if (urlObj.pathname !== '/' || urlObj.search !== '' || urlObj.hash !== '') {
                showToastError("URL must not contain a path, query parameters, or fragment");
                $("#appURLCreate").focus();
                return false;
            }
        } catch (e) {
            showToastError("Please enter a valid URL");
            $("#appURLCreate").focus();
            return false;
        }

        $.ajax({
            url: '/api/v1/addApplication',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                appName: $("#appNameCreate").val(),
                description: $("#appDescriptionCreate").val(),
                appURL: $("#appURLCreate").val(),
                scopesModifiable: $("#scopesModifiableCreate").is(":checked"),
                initializeDefaultsCreate: $("#initializeDefaultsCreate").is(":checked"),
                appKey: $("#appKeyCreate").val()
            }),
            success: function (response, textStatus, xhr) {
                $('#modalCreateApplication').modal('hide');
                // Refresh the DataTable after successful user creation
                var table = new DataTable('#applicationsTable');
                table.ajax.reload();

                showToastSuccess("Application created successfully.");
            },
            error: commonFunctionError
        });
    }

</script>

<div class="modal fade" id="modalCreateApplication" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1"
    aria-labelledby="modalCreateApplicationLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCreateApplicationLabel">Create New Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">


                <table width=100% style=" border-spacing: 10px;   border-collapse: separate;">
                    <tr>
                        <td>
                            <ul class="nav nav-tabs" id="myTabCreate" role="tablist">
                                <li class="nav-item">
                                    <button class="nav-link active" id="details-tab-create" data-bs-toggle="tab"
                                        data-bs-target="#detailsCreate" type="button" role="tab"
                                        aria-controls="detailsCreate" aria-selected="true">Application Details</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" id="advanced-tab-create" data-bs-toggle="tab"
                                        data-bs-target="#advancedCreate" type="button" role="tab"
                                        aria-controls="advancedCreate" aria-selected="false">Advanced Controls</button>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </table>

                <div class="tab-content" id="myTabContentCreate">

                    <div class="tab-pane show active" id="detailsCreate" role="tabpanel"
                        aria-labelledby="details-tab-create" style="min-height: 500px;">
                        <table width=100% style=" border-spacing: 10px;   border-collapse: separate;">
                            <tr>
                                <td align="right">Application Name: </td>
                                <td><input type="text" name="appName" id="appNameCreate" class="form-control"
                                        placeholder="Application Name" style="text-transform: uppercase"
                                        oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9_-]/g, '')">
                                </td>
                            </tr>
                            <tr>
                                <td align="right">Description: </td>
                                <td><input id="appDescriptionCreate" class="form-control" placeholder="Description">
                                </td>
                            </tr>
                            <tr>
                                <td align="right">URL: </td>
                                <td><input id="appURLCreate" class="form-control"
                                        placeholder="Application URL (eg. https://myapp:443)">
                                </td>
                            </tr>
                            <tr>
                                <td align="right">Key: </td>
                                <td>

                                    <div class="input-group">
                                        <input type="password" id="appKeyCreate" class="form-control" placeholder=""
                                            readonly>
                                        <button type="button" class="btn btn-outline-secondary"
                                            id="togglePasswordCreate">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="javascript:generateRandomKey('appKeyCreate')">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>

                                    <script>
                                        document.getElementById('togglePasswordCreate').addEventListener('click', function () {
                                            const passwordField = document.getElementById('appKeyCreate');
                                            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                                            passwordField.setAttribute('type', type);
                                            this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
                                        });
                                    </script>


                                </td>
                            </tr>
                        </table>
                    </div>
                    <!--
                    <div class="tab-pane" id="advancedCreate" role="tabpanel" aria-labelledby="advanced-tab-create"
                        style="min-height: 500px;">
                        <table width=100% style=" border-spacing: 10px;   border-collapse: separate;">
                            <tr>
                                <td align="right">Scopes Modifiable: </td>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scopesModifiableCreate">
                                        <label class="form-check-label" for="scopesModifiableCreate">
                                            Allow manual modification of scopes
                                        </label>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
-->
                    <div class="tab-pane" id="advancedCreate" role="tabpanel" aria-labelledby="advanced-tab-create"
                        style="min-height: 500px;">
                        <div class="container-fluid" style="padding-left: 60px; padding-top: 30px;">
                            <div class="row mb-2">
                                <div class="col-auto">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="scopesModifiableCreate">
                                        <label class="form-check-label" for="scopesModifiableCreate">
                                            Allow manual modification of scopes
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-auto">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="initializeDefaultsCreate">
                                        <label class="form-check-label" for="initializeDefaultsCreate">
                                            Initialize with default values
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- --------------------------------- -->

                </div>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="javascript:ajaxCreateApplication()">Create
                    Application</button>
            </div>
        </div>
    </div>
</div>