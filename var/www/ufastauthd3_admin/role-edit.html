<!--<%include:/includes/inc.main.header.html%>-->
<!--<%include:/includes/inc.layout.leftpanel.header.html%>-->
<!--<%include:/includes/inc.links.roles.html%>-->
<!--<%include:/includes/inc.layout.leftpanel.middle.html%>-->

<table width=100% style=" border-spacing: 10px;   border-collapse: separate;">
  <tr><td align="right" width=15%>Editing Role: </td><td><input type="username" name="username" id="roleName" class="form-control" placeholder="Role Name" readonly></td></tr>
</table>

<table width=100% style=" border-spacing: 10px;   border-collapse: separate;">
<tr>
  <td>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Role Details</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts" type="button" role="tab" aria-controls="accounts" aria-selected="false">Accounts</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="applications-tab" data-bs-toggle="tab" data-bs-target="#applications" type="button" role="tab" aria-controls="applications" aria-selected="false">Applications / Scopes</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">Advanced Controls</button>
      </li>
    </ul>
  </td>
</tr>
</table>
<div class="tab-content" id="myTabContent">

  <div class="tab-pane show active" id="details" role="tabpanel" aria-labelledby="details-tab" style="min-height: 500px;">
      <table width=100% style=" border-spacing: 10px;   border-collapse: separate;">
        <tr><td colspan="2" align="">          <h5>&nbsp;Role Info</h5>      <hr>      </td> </tr>

          <tr><td  align="right">Description: </td><td><input id="description" class="form-control" placeholder="Description"></td></tr>

          <tr><td colspan="2" align="">           <hr>          </td> </tr>
          <tr><td colspan="2" align="right"> <button type="button" class="btn btn-success" onclick="javascript:modifyRoleDetails()">Modify Role Details</button>  </td></tr>

      </table>
  </div>

  <div class="tab-pane" id="accounts" role="tabpanel" aria-labelledby="accounts-tab" style="min-height: 500px;">
    <table width=100% style=" border-spacing: 10px;   border-collapse: separate;">

      <tr>
        <td>
      <table class="table table-hover">
        <thead class="thead-light">
          <tr bgcolor=grey>
            <th scope="col">Username</th>
            <th scope="col">Given/Last Name</th>
            <th scope="col">Description</th>
            <th scope="col" style="text-align: right;">Controls</th>
          </tr>
        </thead>
        <tbody id="roleAccounts">
        </tbody>
      </table>
    </td>
    </tr>

    </table>
  </div>

  <div class="tab-pane" id="applications" role="tabpanel" aria-labelledby="applications-tab"
    style="min-height: 500px;">

    <table width=100% style=" border-spacing: 10px;   border-collapse: separate;">

      <tr id="addApplicationTR"><td align="right">
        <select class="form-select" aria-label="Default select example" id="leftApplicationsList" style="min-width: 300px;" onclick="javascript:populateApplicationScopes()">
        </select><br>
        <select class="form-select" aria-label="Default select example" id="applicationScopes" style="min-width: 300px;">
        </select><br>
        <button type="button" class="btn btn-sm btn-success" onclick="javascript:addApplicationScope()">Add Application + Scope</button>
      </td></tr>

      <tr>
        <td align="center">
          <h5 style="text-align: left;">Role Applications / Scopes:</h5>
          <hr>
        </td>
      </tr>

      <tr>
        <td align="center" id="roleScopesTD">
        </td>
      </tr>
      
    </table>
  </div>

  <div class="tab-pane" id="advanced" role="tabpanel" aria-labelledby="advanced-tab"
    style="min-height: 500px;">

    <table width=100% style=" border-spacing: 10px;   border-collapse: separate;">

      <tr>
        <td align="center">


          <div class="card" style="text-align: center;">
            <div class="card-header">
              Remove This Role
            </div>
            <div class="card-body">
              <h5 class="card-title">    Role Removal Warning!            </h5>
              <p class="card-text">Removing the role will destroy all the information associated in the database.</p>

              <button type="button" class="btn btn-danger btn-sm" onclick="javascript:removeRole()">Remove Role</button>
            </div>
          </div>

        </td>
      </tr>
      
    </table>
  </div>

</div>

<hr>

<script>
  document.getElementById("apptitle").innerHTML = "Roles &#9658; Edit Role";
    document.getElementById("mainview-role-edit-link").style.color = "white";


    function roleAttribRemove(appId,scopeId)
    {
 
      $.ajax({
      url: '/japi_exec?method=scopeRoleRemove',
      headers: { "CSRFToken": csrfToken },
      data: {
        payload: JSON.stringify(
          {
            scopeName: document.getElementById(`ulist-scopeNameById-${appId}-${scopeId}`).value,
            roleName: document.getElementById(`roleName`).value,
            appName: document.getElementById(`userapp-key-${appId}`).value
          }
        )
      },
      type: 'POST',
      success: function (response) {
        if (response["retCode"] == true) {
          populateRole();
        }
        else {
          showToastError("Internal error removing scope from role.");
        }
      },
      error: commonFunctionError
    });

    }

  function addApplicationScope() {
    $.ajax({
      url: '/japi_exec?method=scopeRoleAdd',
      headers: { "CSRFToken": csrfToken },
      data: {
        payload: JSON.stringify(
          {
            scopeName: document.getElementById("applicationScopes").value,
            roleName: document.getElementById(`roleName`).value,
            appName: document.getElementById("leftApplicationsList").value
          }
        )
      },
      type: 'POST',
      success: function (response) {
        if (response["retCode"] == true) {
          populateRole();
        }
        else {
          showToastError("Internal error adding scope to role.");
        }
      },
      error: commonFunctionError
    });

  }

  function populateApplicationScopes() {
    document.getElementById('applicationScopes').innerHTML = "";

    $.ajax({
      url: '/japi_exec?method=scopesLeftListForRole',
      headers: { "CSRFToken": csrfToken },
      data: {
        payload: JSON.stringify(
          {
            roleName: document.getElementById(`roleName`).value,
            appName: document.getElementById("leftApplicationsList").value
          }
        )
      },
      type: 'POST',
      success: function (response) {
        if (response["scopesLeft"] != null) {
          for (let scope of response["scopesLeft"]) {
            var sel = document.getElementById(`applicationScopes`);
            var opt = document.createElement('option');
            opt.appendChild(document.createTextNode(scope["name"] + ': ' + scope["description"]));
            opt.value = scope["name"];
            sel.appendChild(opt);
          }
        }
      },
      error: commonFunctionError
    });

  }

  function roleAccountRemove(accountId) {
    $.ajax({
      url: '/japi_exec?method=roleAccountRemove',
      headers: { "CSRFToken": csrfToken },
      data: {
        payload: JSON.stringify(
          {
            roleName: document.getElementById(`roleName`).value,
            accountName: document.getElementById(`ulist-accountNameById-${accountId}`).value
          }
        )
      },
      type: 'POST',
      success: function (response) {
        if (response["retCode"] == true) {
          populateRole();
        }
        else {
          showToastError("Internal error removing account from role.");
        }
      },
      error: commonFunctionError
    });
  }

  function modifyRoleDetails() {
    $.ajax({
      url: '/japi_exec?method=roleChangeDescription',
      headers: { "CSRFToken": csrfToken },
      data: {
        payload: JSON.stringify(
          {
            roleName: $("#roleName").val(),
            roleDescription: $("#description").val(),
          }
        )
      },
      type: 'POST',
      success: function (response) {
        if (response["retCode"] == true) {
          showToastSuccess("Role Information Modified!");
        }
        else {
          showToastError("Internal error modifying the role.");
        }
      },
      error: commonFunctionError
    });
  }

  function removeRole() {
    var r = confirm("Do you really want to completly remove this role?\nConsider disabling it instead.");
    if (r == true) {
      $.ajax({
        url: '/japi_exec?method=roleRemove',
        headers: { "CSRFToken": csrfToken },
        data: { payload: JSON.stringify({ roleName: $("#roleName").val() }) },
        type: 'POST',
        success: function (response) {
          if (response["retCode"] == true) {
            showToastSuccess("Role Removed!");
          }
          else {
            showToastError("Internal error removing the role.");
          }
          window.location = "/roles";
        },
        error: commonFunctionError
      });
    } else {
      showToastError("Remove Operation Aborted!");
    }
  }

  function populateRole() {

    var roleName = $("#roleName").val();
    $.ajax({
      url: '/japi_exec?method=roleBasicInfo',
      headers: { "CSRFToken": csrfToken },
      data: { payload: JSON.stringify({ roleName: $("#roleName").val() }) },
      type: 'POST',
      success: function (response) {

        document.getElementById("description").value = response["description"];


        document.getElementById('roleAccounts').innerHTML = "";
        document.getElementById('roleScopesTD').innerHTML = "";
        document.getElementById('leftApplicationsList').innerHTML = "";

        if (response["accounts"] != null) {

          let accountId = 0;

          for (let account of response["accounts"]) {

            document.getElementById(`roleAccounts`).innerHTML += `<tr> 
                <th scope="row" id=ulist-accountName-${accountId} width=20%></th>
                <td id=ulist-accountGivenAndLastName-${accountId}></td>
                <td id=ulist-accountDescription-${accountId}></td>
                <td style="text-align: right;">
                  <input type=hidden id="ulist-accountNameById-${accountId}">
                  <button type="button" class="btn btn-light btn-sm" onclick="javascript:roleAccountRemove(${accountId});">&#10006;</button>
                </td>
              </tr>`;

            document.getElementById(`ulist-accountNameById-${accountId}`).value = account["name"];
            $(`#ulist-accountName-${accountId}`).text(account["name"]);
            $(`#ulist-accountGivenAndLastName-${accountId}`).text(account["givenName"] + " " + account["lastName"]);
            $(`#ulist-accountDescription-${accountId}`).text(account["description"]);
            accountId++;
          }
        }

        // roleScopesTD

        if (response["applications"] != null) {
          let appId = 0;
          for (let application of response["applications"]) {

            $("#roleScopesTD").append(
              `
              <input type=hidden id="userapp-key-${appId}">
              <div class="card" style="max-width: 80%; text-align: left;">
              <div class="card-header">
                  <h5 style="float: left; width: 100%; text-align: left;" id="userapp-title-${appId}">Text</h2>
                  <!--<p style="float: left; width: 50%; text-align: right;">  <button type="button" class="btn btn-sm btn-light" onclick="javascript:removeApplication('${appId}')">	&#10006;</button> </p>-->
              </div>

              <div class="card-body">

              <p class="card-text">
                  <table class="table table-hover">
                    <thead class="thead-light">
                      <tr bgcolor=grey>
                        <th scope="col">Scope Name</th>
                        <th scope="col">Description</th>
                        <th scope="col" style="text-align: right;">Controls</th>
                      </tr>
                    </thead>
                    <tbody id="applicationsDirectScopes-${appId}">
                    </tbody>
                  </table>
               </p>

              </div>
              </div>
              <br>
              `
            );
            $(`#userapp-title-${appId}`).text(application["name"] + ': ' + application["description"]);
            $(`#userapp-key-${appId}`).val(application["name"]);

            //leftApplicationsList

            if (application["scopes"] != null) {
              let scopeId = 0;
              for (let scope of application["scopes"]) {

                document.getElementById(`applicationsDirectScopes-${appId}`).innerHTML += `<tr> 
                <th scope="row" id=ulist-scopeName-${appId}-${scopeId} width=20%></th>
                <td id=ulist-scopeDescription-${appId}-${scopeId}></td>
                <td style="text-align: right;">
                  <input type=hidden id="ulist-scopeNameById-${appId}-${scopeId}">
                  <button type="button" class="btn btn-light btn-sm" onclick="javascript:roleAttribRemove(${appId},${scopeId});">&#10006;</button>
                </td>
                </tr>`;

                document.getElementById(`ulist-scopeNameById-${appId}-${scopeId}`).value = scope["name"];
                $(`#ulist-scopeName-${appId}-${scopeId}`).text(scope["name"]);
                $(`#ulist-scopeDescription-${appId}-${scopeId}`).text(scope["description"]);

                scopeId++;
              }
            }

            appId++;
          }
        }


        if (response["leftApplicationsList"] != null) {
          for (let application of response["leftApplicationsList"]) {
            var sel = document.getElementById(`leftApplicationsList`);
            var opt = document.createElement('option');
            opt.appendChild(document.createTextNode(application["name"] + ': ' + application["description"]));
            opt.value = application["name"];
            sel.appendChild(opt);
          }
        }

        populateApplicationScopes();



      },
      error: commonFunctionError
    });
  }

  function ajaxValidateAndPopulateRole() {
    var roleName = window.atob(location.search.substr(1));
    $.ajax({
      url: '/japi_exec?method=roleExist',
      headers: { "CSRFToken": csrfToken },
      data: { payload: JSON.stringify({ roleName: $("#roleName").val() }) },
      type: 'POST',
      success: function (response) {
        document.getElementById("roleName").value = roleName;
        populateRole();
      },
      error: commonFunctionError
    });
  }

  function csrfReady() {
    ajaxValidateAndPopulateRole();
  }


</script>

<!--<%include:/includes/inc.layout.leftpanel.footer.html%>-->
<!--<%include:/includes/inc.main.footer.html%>-->
